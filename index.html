<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gordon on Blackjack</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --card-w: 60px;
      --card-h: 88px;
      --card-rank: 17px;
      --card-suit: 24px;
      --btn-font: 9px;
      --btn-pad: 10px 16px;
      --gap: 20px;
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background: #000;
      color: #fff;
      image-rendering: pixelated;
      min-height: 100vh;
    }

    /* â”€â”€â”€ BUTTONS â”€â”€â”€ */
    .nes-btn {
      border: 3px solid #fff;
      padding: var(--btn-pad);
      font-family: 'Press Start 2P', cursive;
      font-size: var(--btn-font);
      cursor: pointer;
      transition: transform 0.08s, box-shadow 0.08s;
      box-shadow: 4px 4px 0 #000;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .nes-btn:hover:not(:disabled),
    .nes-btn:active:not(:disabled) {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }
    .nes-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    /* â”€â”€â”€ CARDS â”€â”€â”€ */
    .nes-card {
      background: linear-gradient(135deg, #fff 0%, #e8e8e8 100%);
      border: 3px solid #000;
      box-shadow: inset -2px -2px 0 #999, inset 2px 2px 0 #fff;
    }
    .pixel-card {
      width: var(--card-w);
      height: var(--card-h);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .pixel-card .card-rank { font-size: var(--card-rank); }
    .pixel-card .card-suit { font-size: var(--card-suit); }

    /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
    .app-wrapper {
      padding: 12px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Desktop: side-by-side */
    .main-layout {
      display: flex;
      gap: 25px;
      align-items: flex-start;
    }
    .game-col { flex: 1; min-width: 0; }
    .chat-col {
      width: 400px;
      flex-shrink: 0;
      position: sticky;
      top: 12px;
    }

    /* â”€â”€â”€ STATS BAR â”€â”€â”€ */
    .stats-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ ACTION BUTTONS ROW â”€â”€â”€ */
    .action-btns {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ RULES CHIPS â”€â”€â”€ */
    .rules-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }

    /* â”€â”€â”€ SPLIT HANDS â”€â”€â”€ */
    .split-hands-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* â”€â”€â”€ CHAT â”€â”€â”€ */
    .chat-messages {
      border: 3px solid #666;
      background: #0a0a0a;
      padding: 12px;
      margin-bottom: 12px;
      min-height: 380px;
      max-height: 480px;
      overflow-y: auto;
      font-size: 9px;
      line-height: 1.5;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
    }
    .chat-input-row input {
      flex: 1;
      min-width: 0;
      padding: 10px;
      border: 3px solid #fff;
      background: #000;
      color: #fff;
      font-family: 'Press Start 2P', cursive;
      font-size: 8px;
      outline: none;
    }

    /* â”€â”€â”€ MOBILE (<= 900px): stack columns â”€â”€â”€ */
    @media (max-width: 900px) {
      :root {
        --card-w: 54px;
        --card-h: 78px;
        --card-rank: 15px;
        --card-suit: 21px;
        --btn-font: 8px;
        --btn-pad: 10px 14px;
        --gap: 14px;
      }

      .main-layout {
        flex-direction: column;
        gap: 16px;
      }
      .chat-col {
        width: 100%;
        position: static;
      }
      .chat-messages {
        min-height: 260px;
        max-height: 340px;
      }
    }

    /* â”€â”€â”€ SMALL MOBILE (<= 480px) â”€â”€â”€ */
    @media (max-width: 480px) {
      :root {
        --card-w: 46px;
        --card-h: 66px;
        --card-rank: 13px;
        --card-suit: 18px;
        --btn-font: 7px;
        --btn-pad: 9px 12px;
      }

      .app-wrapper { padding: 8px; }

      .nes-btn { box-shadow: 3px 3px 0 #000; }

      .action-btns { gap: 7px; }

      h1 { font-size: clamp(11px, 4.5vw, 22px) !important; }
    }

    /* â”€â”€â”€ VERY SMALL (<= 360px) â”€â”€â”€ */
    @media (max-width: 360px) {
      :root {
        --card-w: 40px;
        --card-h: 58px;
        --card-rank: 11px;
        --card-suit: 15px;
        --btn-font: 6px;
        --btn-pad: 8px 10px;
      }
    }

    /* Scrollbar styling */
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: #111; }
    .chat-messages::-webkit-scrollbar-thumb { background: #444; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUITS = ['â™ ','â™¥','â™¦','â™£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

const BASIC_STRATEGY = {
  hard: {
    21:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    20:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    19:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    18:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    17:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    16:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H','A':'H'},
    15:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H','A':'H'},
    14:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H','A':'H'},
    13:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H','A':'H'},
    12:{2:'H',3:'H',4:'S',5:'S',6:'S',7:'H',8:'H',9:'H',10:'H','A':'H'},
    11:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'D','A':'D'},
    10:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'H','A':'H'},
    9: {2:'H',3:'D',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
    8: {2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H','A':'H'},
    7: {2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H','A':'H'},
    6: {2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H','A':'H'},
    5: {2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H','A':'H'},
    4: {2:'H',3:'H',4:'H',5:'H',6:'H',7:'H',8:'H',9:'H',10:'H','A':'H'},
  },
  soft: {
    21:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    20:{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    19:{2:'S',3:'S',4:'S',5:'S',6:'D',7:'S',8:'S',9:'S',10:'S','A':'S'},
    18:{2:'D',3:'D',4:'D',5:'D',6:'D',7:'S',8:'S',9:'H',10:'H','A':'H'},
    17:{2:'H',3:'D',4:'D',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
    16:{2:'H',3:'H',4:'H',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
    15:{2:'H',3:'H',4:'H',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
    14:{2:'H',3:'H',4:'H',5:'H',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
    13:{2:'H',3:'H',4:'H',5:'D',6:'D',7:'H',8:'H',9:'H',10:'H','A':'H'},
  },
  pair: {
    'A,A':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'P',9:'P',10:'P','A':'P'},
    '10,10':{2:'S',3:'S',4:'S',5:'S',6:'S',7:'S',8:'S',9:'S',10:'S','A':'S'},
    '9,9':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'S',8:'P',9:'P',10:'S','A':'S'},
    '8,8':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'P',9:'P',10:'P','A':'P'},
    '7,7':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H','A':'H'},
    '6,6':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'H',8:'H',9:'H',10:'H','A':'H'},
    '5,5':{2:'D',3:'D',4:'D',5:'D',6:'D',7:'D',8:'D',9:'D',10:'H','A':'H'},
    '4,4':{2:'H',3:'H',4:'H',5:'P',6:'P',7:'H',8:'H',9:'H',10:'H','A':'H'},
    '3,3':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H','A':'H'},
    '2,2':{2:'P',3:'P',4:'P',5:'P',6:'P',7:'P',8:'H',9:'H',10:'H','A':'H'},
  }
};

const ACTION_NAMES = {'H':'Hit','S':'Stand','D':'Double','P':'Split'};

function GordonOnBlackjack() {
  const [playerHand, setPlayerHand] = useState([]);
  const [dealerHand, setDealerHand] = useState([]);
  const [correctAction, setCorrectAction] = useState('');
  const [feedback, setFeedback] = useState('');
  const [stats, setStats] = useState({correct:0, total:0});
  const [winStats, setWinStats] = useState({wins:0, handsTotal:0});
  const [gamePhase, setGamePhase] = useState('betting');
  const [splitHands, setSplitHands] = useState(null);
  const [activeSplitIdx, setActiveSplitIdx] = useState(0);
  const [wrongFeedback, setWrongFeedback] = useState('');
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [isLoadingChat, setIsLoadingChat] = useState(false);
  const chatRef = useRef(null);

  useEffect(() => {
    if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
  }, [chatMessages]);

  const getCardValue = r => r === 'A' ? 11 : ['J','Q','K'].includes(r) ? 10 : parseInt(r);
  const generateRandomCard = () => {
    const rank = RANKS[Math.floor(Math.random() * RANKS.length)];
    const suit = SUITS[Math.floor(Math.random() * SUITS.length)];
    return {rank, suit, value: getCardValue(rank)};
  };

  const calculateHandValue = hand => {
    let total = 0, aces = 0;
    hand.forEach(c => { if(c.rank==='A'){aces++; total+=11;} else total+=c.value; });
    while(total>21 && aces>0){total-=10; aces--;}
    return total;
  };

  const isSoftHand = hand => {
    if(!hand.some(c=>c.rank==='A')) return false;
    let total=0, aces=0;
    hand.forEach(c => { if(c.rank==='A'){aces++; total+=11;} else total+=c.value; });
    while(total>21 && aces>0){total-=10; aces--;}
    return aces>0 && total<=21;
  };

  const getCorrectAction = (playerCards, dHand) => {
    const du = dHand[0];
    const dr = ['J','Q','K'].includes(du.rank) ? '10' : du.rank;
    if(playerCards.length===2 && playerCards[0].rank===playerCards[1].rank){
      const r1 = ['J','Q','K'].includes(playerCards[0].rank)?'10':playerCards[0].rank;
      const r2 = ['J','Q','K'].includes(playerCards[1].rank)?'10':playerCards[1].rank;
      const pk = `${r1},${r2}`;
      if(BASIC_STRATEGY.pair[pk]) return BASIC_STRATEGY.pair[pk][dr];
    }
    if(isSoftHand(playerCards)){
      const t = calculateHandValue(playerCards);
      if(BASIC_STRATEGY.soft[t]) return BASIC_STRATEGY.soft[t][dr];
    }
    const t = calculateHandValue(playerCards);
    return BASIC_STRATEGY.hard[t]?.[dr] || 'H';
  };

  const getExplanation = (playerCards, dHand, action, isCorrect) => {
    const du = dHand[0];
    const dr = ['J','Q','K'].includes(du.rank)?'10':du.rank;
    const total = calculateHandValue(playerCards);
    const isSoft = isSoftHand(playerCards);
    const isPair = playerCards.length===2 && playerCards[0].rank===playerCards[1].rank;
    let explanation = '';
    if(isPair){
      const rank = playerCards[0].rank;
      if(rank==='A') explanation="Always split Aces. No exceptions â€” not even for me.";
      else if(rank==='8') explanation="Always split 8s. Sixteen is a garbage hand. Two eights? At least you've got options.";
      else if(['10','J','Q','K'].includes(rank)) explanation="Never split 10s. You're sitting on 20. Don't get clever.";
      else if(rank==='9'&&['7','10','A'].includes(dr)) explanation=`Nine-nine vs ${dr} â€” you stand. Your 18 is good enough here.`;
      else explanation=`Book says ${ACTION_NAMES[correctAction]} with ${rank}s vs ${dr}. Trust the math.`;
    } else if(isSoft){
      if(total>=19) explanation=`Soft ${total}. You're in good shape â€” stand and let the dealer sweat.`;
      else if(total===18&&['9','10','A'].includes(dr)) explanation=`Soft 18 vs a ${dr}? That ace gives you wiggle room. Use it â€” hit.`;
      else explanation=`Book says ${ACTION_NAMES[correctAction]} on soft ${total} vs ${dr}.`;
    } else {
      if(total>=17) explanation=`Hard ${total}. You stand. Unless you enjoy losing.`;
      else if(total===16&&['7','8','9','10','A'].includes(dr)) explanation=`Sixteen vs a ${dr} â€” yeah, this one hurts either way. Hit it.`;
      else if(total===12&&['4','5','6'].includes(dr)) explanation=`Stand on 12 vs ${dr}. Dealer's more likely to bust than you are. Let them do the work.`;
      else if(total===11) explanation="Eleven. You double. Every time. That's not a suggestion.";
      else if(total===10&&!['10','A'].includes(dr)) explanation=`Double on 10 vs ${dr}. Good spot to press your advantage.`;
      else explanation=`Book says ${ACTION_NAMES[correctAction]} on ${total} vs ${dr}.`;
    }
    return isCorrect ? `âœ“ ${explanation}` : `âœ— Should ${ACTION_NAMES[correctAction]}. ${explanation}`;
  };

  const dealNewHand = () => {
    const player = [generateRandomCard(), generateRandomCard()];
    const dealer = [generateRandomCard(), generateRandomCard()];
    setPlayerHand(player); setDealerHand(dealer);
    setGamePhase('player'); setFeedback(''); setWrongFeedback('');
    setSplitHands(null); setActiveSplitIdx(0);
    if(calculateHandValue(player)===21){
      setGamePhase('complete');
      const bj = calculateHandValue(dealer)!==21;
      setFeedback(bj?'âœ“ BLACKJACK!':'PUSH!');
      setWinStats(prev=>({wins:prev.wins+(bj?1:0), handsTotal:prev.handsTotal+1}));
    } else {
      setCorrectAction(getCorrectAction(player, dealer));
    }
  };

  const activeCards = () => splitHands ? splitHands[activeSplitIdx].cards : playerHand;

  const resolveDealer = hands => {
    let dc = [...dealerHand];
    while(calculateHandValue(dc)<17) dc.push(generateRandomCard());
    setDealerHand(dc);
    const dt = calculateHandValue(dc);
    let sw = 0;
    const results = hands.map(({cards})=>{
      const t = calculateHandValue(cards);
      const r = t>21?'BUST': dt>21?'WIN': t>dt?'WIN': t<dt?'LOSE':'PUSH';
      if(r==='WIN') sw++;
      return r;
    });
    setSplitHands(hands.map((h,i)=>({...h, result:results[i]})));
    setWinStats(prev=>({wins:prev.wins+sw, handsTotal:prev.handsTotal+hands.length}));
    setFeedback(`DEALER: ${dt}${dt>21?' (BUST)':''}`);
    setGamePhase('complete');
  };

  const advanceSplitOrResolve = (updatedHands, doneIdx) => {
    const nextIdx = doneIdx+1;
    if(nextIdx < updatedHands.length){
      setSplitHands(updatedHands); setActiveSplitIdx(nextIdx);
      setCorrectAction(getCorrectAction(updatedHands[nextIdx].cards, dealerHand));
      setFeedback(''); setWrongFeedback('');
    } else { resolveDealer(updatedHands); }
  };

  const handleHit = () => {
    const current = activeCards();
    const newHand = [...current, generateRandomCard()];
    const newTotal = calculateHandValue(newHand);
    if(splitHands){
      const updated = splitHands.map((h,i)=>i===activeSplitIdx?{...h,cards:newHand}:h);
      setSplitHands(updated);
      if(newTotal>21){ advanceSplitOrResolve(updated, activeSplitIdx); }
      else { setCorrectAction(getCorrectAction(newHand, dealerHand)); setFeedback(''); }
    } else {
      setPlayerHand(newHand);
      if(newTotal>21){
        setWinStats(prev=>({...prev, handsTotal:prev.handsTotal+1}));
        setFeedback(`BUST! ${newTotal}`); setGamePhase('complete');
      } else if(newTotal===21){ handleStand(newHand); }
      else { setCorrectAction(getCorrectAction(newHand, dealerHand)); setFeedback(''); }
    }
  };

  const handleStand = hand => {
    const standHand = hand || activeCards();
    if(splitHands){
      const updated = splitHands.map((h,i)=>i===activeSplitIdx?{...h,cards:standHand}:h);
      advanceSplitOrResolve(updated, activeSplitIdx);
    } else {
      let dc = [...dealerHand];
      while(calculateHandValue(dc)<17) dc.push(generateRandomCard());
      setDealerHand(dc);
      const pt = calculateHandValue(standHand), dt = calculateHandValue(dc);
      const result = dt>21?'WIN - DEALER BUST': pt>dt?'YOU WIN': pt<dt?'DEALER WINS':'PUSH';
      const isWin = result==='WIN - DEALER BUST'||result==='YOU WIN';
      setWinStats(prev=>({wins:prev.wins+(isWin?1:0), handsTotal:prev.handsTotal+1}));
      setFeedback(result); setGamePhase('complete');
    }
  };

  const handleDouble = () => {
    const newHand = [...activeCards(), generateRandomCard()];
    if(splitHands){
      const updated = splitHands.map((h,i)=>i===activeSplitIdx?{...h,cards:newHand}:h);
      setSplitHands(updated);
      if(calculateHandValue(newHand)>21){ advanceSplitOrResolve(updated, activeSplitIdx); }
      else { advanceSplitOrResolve(updated, activeSplitIdx); }
    } else {
      setPlayerHand(newHand);
      if(calculateHandValue(newHand)>21){
        setWinStats(prev=>({...prev, handsTotal:prev.handsTotal+1}));
        setFeedback(`BUST! ${calculateHandValue(newHand)}`); setGamePhase('complete');
      } else { handleStand(newHand); }
    }
  };

  const handleSplit = () => {
    const ah = activeCards();
    const hand1 = [ah[0], generateRandomCard()];
    const hand2 = [ah[1], generateRandomCard()];
    if(splitHands){
      const before = splitHands.slice(0,activeSplitIdx);
      const after  = splitHands.slice(activeSplitIdx+1);
      const newHands = [...before,{cards:hand1},{cards:hand2},...after];
      setSplitHands(newHands); setCorrectAction(getCorrectAction(hand1,dealerHand)); setFeedback('');
    } else {
      setSplitHands([{cards:hand1},{cards:hand2}]);
      setActiveSplitIdx(0); setCorrectAction(getCorrectAction(hand1,dealerHand)); setFeedback('');
    }
  };

  const handleAction = action => {
    const isCorrect = action === correctAction;
    const current = activeCards();
    setStats(prev=>({correct:prev.correct+(isCorrect?1:0), total:prev.total+1}));
    if(!isCorrect){
      const explanation = getExplanation(current, dealerHand, action, false);
      splitHands ? setWrongFeedback(explanation) : setFeedback(explanation);
      return;
    }
    setWrongFeedback('');
    switch(action){
      case 'H': handleHit(); break;
      case 'S': handleStand(); break;
      case 'D': if(current.length===2) handleDouble(); break;
      case 'P': if(current.length===2) handleSplit(); break;
    }
  };

  const handleChatSubmit = async () => {
    if(!chatInput.trim() || isLoadingChat) return;
    const userMessage = chatInput.trim();
    setChatInput('');
    setChatMessages(prev=>[...prev,{role:'user',content:userMessage}]);
    setIsLoadingChat(true);
    const handContext = `Player: ${playerHand.map(c=>c.rank+c.suit).join(', ')} (Total: ${calculateHandValue(playerHand)}${isSoftHand(playerHand)?' - Soft':''}) | Dealer showing: ${dealerHand[0]?.rank}${dealerHand[0]?.suit} | Correct action: ${ACTION_NAMES[correctAction]||'N/A'}`;
    try {
      const response = await fetch('https://gordon-on-blackjack.vercel.app/api/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message:userMessage, handContext})
      });
      const data = await response.json();
      setIsLoadingChat(false);
      if(data.error){ setChatMessages(prev=>[...prev,{role:'assistant',content:`Error: ${data.error}`}]); return; }
      setChatMessages(prev=>[...prev,{role:'assistant',content:'',isTyping:true}]);
      const full = data.message;
      let i = 0;
      const ti = setInterval(()=>{
        i++;
        const partial = full.substring(0,i);
        setChatMessages(prev=>{
          const n=[...prev];
          n[n.length-1]={role:'assistant',content:partial,isTyping:i<full.length};
          return n;
        });
        if(i>=full.length) clearInterval(ti);
      },20);
    } catch(err){
      setChatMessages(prev=>[...prev,{role:'assistant',content:'Error reaching Gordon.'}]);
      setIsLoadingChat(false);
    }
  };

  useEffect(()=>{ dealNewHand(); },[]);

  const accuracy = stats.total>0 ? Math.round(stats.correct/stats.total*100) : 0;
  const winPct   = winStats.handsTotal>0 ? Math.round(winStats.wins/winStats.handsTotal*100) : 0;

  const isRed = suit => suit==='â™¥'||suit==='â™¦';

  /* â”€â”€ CARD COMPONENT â”€â”€ */
  const Card = ({card, faceDown=false, small=false}) => {
    if(faceDown) return (
      <div className="pixel-card" style={{
        background:'linear-gradient(135deg,#0066cc,#003399)',
        border:'3px solid #fff', color:'#fff',
        width:small?'40px':'var(--card-w)', height:small?'58px':'var(--card-h)',
        display:'flex', alignItems:'center', justifyContent:'center', fontSize:'28px'
      }}>ðŸ‚ </div>
    );
    return (
      <div className={`nes-card pixel-card`} style={{
        color: isRed(card.suit)?'#ff0000':'#000',
        width:small?'40px':'var(--card-w)', height:small?'58px':'var(--card-h)'
      }}>
        <div className="card-rank" style={small?{fontSize:'11px'}:{}}>{card.rank}</div>
        <div className="card-suit" style={small?{fontSize:'16px'}:{}}>{card.suit}</div>
      </div>
    );
  };

  return (
    <div className="app-wrapper">

      {/* â”€â”€ TITLE â”€â”€ */}
      <div style={{background:'linear-gradient(90deg,#ff0000,#ffaa00,#ff0000)', padding:'3px', marginBottom:'16px'}}>
        <div style={{background:'#000', padding:'14px', textAlign:'center'}}>
          <h1 style={{color:'#ffff00', fontSize:'clamp(12px,4.5vw,28px)', textShadow:'3px 3px 0 #aa0000', marginBottom:'10px', lineHeight:'1.4'}}>
            GORDON ON BLACKJACK
          </h1>
          <div className="rules-row">
            {[{l:'DECKS',v:'6'},{l:'DEALER',v:'S17'},{l:'DOUBLE',v:'ANY 2'},{l:'DAS',v:'YES'},{l:'SPLIT',v:'UP TO 3x'},{l:'BLACKJACK',v:'3:2'}]
              .map(({l,v})=>(
              <div key={l} style={{border:'2px solid #444', padding:'4px 8px', textAlign:'center', background:'#111', minWidth:'64px'}}>
                <div style={{color:'#888', fontSize:'6px', marginBottom:'2px'}}>{l}</div>
                <div style={{color:'#00ff00', fontSize:'8px'}}>{v}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* â”€â”€ MAIN LAYOUT â”€â”€ */}
      <div className="main-layout">

        {/* â”€â”€â”€ GAME COLUMN â”€â”€â”€ */}
        <div className="game-col">
          <div style={{background:'#1a1a1a', border:'5px solid #333', padding:'14px', borderRadius:'6px'}}>
            <div style={{background:'linear-gradient(180deg,#1a5f3a,#0d3d26)', border:'4px solid #2a7f4a', padding:'14px', borderRadius:'4px'}}>

              {/* DEALER HAND */}
              <div style={{marginBottom:'24px'}}>
                <div style={{color:'#ffff00', fontSize:'9px', marginBottom:'8px'}}>
                  <span style={{color:'#ff0000'}}>â–¸</span> DEALER
                </div>
                <div style={{display:'flex', justifyContent:'center', gap:'8px', flexWrap:'wrap'}}>
                  {dealerHand.map((card,idx)=>(
                    <Card key={idx} card={card} faceDown={idx===1 && gamePhase==='player'} />
                  ))}
                </div>
                {gamePhase!=='player' && (
                  <div style={{textAlign:'center', marginTop:'8px'}}>
                    <span style={{background:'rgba(0,0,0,0.7)', border:'2px solid #00ff00', display:'inline-block', padding:'4px 12px', fontSize:'9px', color:'#00ff00'}}>
                      TOTAL: {calculateHandValue(dealerHand)}
                    </span>
                  </div>
                )}
              </div>

              {/* PLAYER HAND(S) */}
              <div style={{marginBottom:'16px'}}>
                <div style={{color:'#ffff00', fontSize:'9px', marginBottom:'8px'}}>
                  <span style={{color:'#00ff00'}}>â–¸</span> YOU{splitHands?` â€” HAND ${activeSplitIdx+1} OF ${splitHands.length}`:''}
                </div>

                {splitHands ? (
                  <div className="split-hands-row">
                    {splitHands.map((hand,idx)=>{
                      const isActive = idx===activeSplitIdx && gamePhase==='player';
                      const result = hand.result;
                      const rc = result==='WIN'?'#00ff00': result==='LOSE'||result==='BUST'?'#ff4444':'#ffaa00';
                      return (
                        <div key={idx} style={{
                          border:`3px solid ${isActive?'#ffff00':result?rc:'#444'}`,
                          padding:'8px', background:isActive?'rgba(255,255,0,0.05)':'rgba(0,0,0,0.3)',
                          borderRadius:'4px', minWidth:'100px', textAlign:'center', position:'relative'
                        }}>
                          {isActive&&<div style={{position:'absolute',top:'-11px',left:'50%',transform:'translateX(-50%)',background:'#ffff00',color:'#000',fontSize:'6px',padding:'2px 5px',whiteSpace:'nowrap'}}>â–¶ PLAYING</div>}
                          <div style={{color:'#888',fontSize:'6px',marginBottom:'5px'}}>HAND {idx+1}</div>
                          <div style={{display:'flex',gap:'4px',justifyContent:'center',flexWrap:'wrap',marginBottom:'6px'}}>
                            {hand.cards.map((c,ci)=><Card key={ci} card={c} small />)}
                          </div>
                          <div style={{color:result?rc:'#00ff00',fontSize:'7px'}}>
                            {result?result:`${calculateHandValue(hand.cards)}${isSoftHand(hand.cards)?' (S)':''}`}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div>
                    <div style={{display:'flex',justifyContent:'center',gap:'8px',flexWrap:'wrap'}}>
                      {playerHand.map((card,idx)=><Card key={idx} card={card} />)}
                    </div>
                    <div style={{textAlign:'center',marginTop:'8px'}}>
                      <span style={{background:'rgba(0,0,0,0.7)',border:'2px solid #00ff00',display:'inline-block',padding:'4px 12px',fontSize:'9px',color:'#00ff00'}}>
                        TOTAL: {calculateHandValue(playerHand)} {isSoftHand(playerHand)&&'(SOFT)'}
                      </span>
                    </div>
                  </div>
                )}
              </div>

              {/* ACTION BUTTONS */}
              {gamePhase==='player' && (
                <div style={{marginBottom:'16px'}}>
                  <div style={{textAlign:'center',marginBottom:'12px',color:'#fff',fontSize:'9px'}}>
                    {splitHands?`HAND ${activeSplitIdx+1}: WHAT DO YOU DO?`:'WHAT DO YOU DO?'}
                  </div>
                  {wrongFeedback && (
                    <div style={{background:'#6a0000',border:'2px solid #ff4444',padding:'10px',color:'#fff',fontSize:'8px',textAlign:'center',marginBottom:'10px'}}>
                      {wrongFeedback}
                    </div>
                  )}
                  <div className="action-btns">
                    <button onClick={()=>handleAction('H')} className="nes-btn" style={{background:'#0066ff',color:'#fff'}}>HIT</button>
                    <button onClick={()=>handleAction('S')} className="nes-btn" style={{background:'#ff0000',color:'#fff'}}>STAND</button>
                    <button onClick={()=>handleAction('D')} disabled={activeCards().length>2} className="nes-btn" style={{background:'#ffaa00',color:'#000'}}>DOUBLE</button>
                    <button
                      onClick={()=>handleAction('P')}
                      disabled={activeCards().length>2||(splitHands&&splitHands.length>=3)}
                      className="nes-btn" style={{background:'#aa00ff',color:'#fff'}}>SPLIT</button>
                  </div>
                </div>
              )}

              {/* FEEDBACK */}
              {feedback && (
                <div style={{
                  background: feedback.startsWith('âœ—')?'#aa0000':
                    gamePhase==='complete'&&splitHands?'#1a3a1a':
                    feedback.includes('WIN')||feedback.startsWith('âœ“')?'#00aa00':'#0066ff',
                  border:'3px solid #fff', padding:'12px', color:'#fff',
                  fontSize:'9px', textAlign:'center', whiteSpace:'pre-wrap', marginBottom:'10px'
                }}>{feedback}</div>
              )}

              {/* NEXT HAND */}
              {(gamePhase==='complete'||feedback.startsWith('âœ—')) && (
                <div style={{textAlign:'center',marginTop:'12px'}}>
                  <button onClick={dealNewHand} className="nes-btn" style={{background:'#00aa00',color:'#fff',fontSize:'10px',padding:'12px 24px'}}>
                    NEXT HAND
                  </button>
                </div>
              )}

            </div>
          </div>

          {/* SESSION STATS */}
          <div style={{background:'#333',border:'4px solid #fff',padding:'12px',marginTop:'12px'}}>
            <div style={{color:'#ffaa00',fontSize:'7px',textAlign:'center',marginBottom:'8px',letterSpacing:'2px'}}>SESSION STATS</div>
            <div className="stats-row">
              <div style={{textAlign:'center'}}>
                <div style={{color:'#888',fontSize:'6px',marginBottom:'3px'}}>STRATEGY ACCURACY</div>
                <div style={{color:'#00ff00',fontSize:'9px'}}>{stats.correct}/{stats.total} ({accuracy}%)</div>
              </div>
              <div style={{width:'2px',background:'#555'}} />
              <div style={{textAlign:'center'}}>
                <div style={{color:'#888',fontSize:'6px',marginBottom:'3px'}}>HANDS WON</div>
                <div style={{color:'#00ff00',fontSize:'9px'}}>{winStats.wins}/{winStats.handsTotal} ({winPct}%)</div>
              </div>
            </div>
          </div>
        </div>

        {/* â”€â”€â”€ GORDON CHAT COLUMN â”€â”€â”€ */}
        <div className="chat-col">
          <div style={{background:'#1a1a1a',border:'4px solid #fff',padding:'16px'}}>

            {/* Gordon header */}
            <div style={{textAlign:'center',marginBottom:'12px'}}>
              <div style={{marginBottom:'8px'}} dangerouslySetInnerHTML={{__html:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="90" height="90" style="image-rendering:pixelated"><style>.pixel{shape-rendering:crispEdges}</style><rect class="pixel" x="20" y="12" width="4" height="4" fill="#FFDBAC"/><rect class="pixel" x="24" y="8" width="16" height="4" fill="#FFDBAC"/><rect class="pixel" x="40" y="12" width="4" height="4" fill="#FFDBAC"/><rect class="pixel" x="16" y="16" width="32" height="16" fill="#FFDBAC"/><rect class="pixel" x="20" y="4" width="24" height="4" fill="#5D4037"/><rect class="pixel" x="16" y="8" width="32" height="4" fill="#5D4037"/><rect class="pixel" x="16" y="12" width="4" height="4" fill="#5D4037"/><rect class="pixel" x="44" y="12" width="4" height="4" fill="#5D4037"/><rect class="pixel" x="24" y="4" width="4" height="2" fill="#795548"/><rect class="pixel" x="32" y="4" width="4" height="2" fill="#795548"/><rect class="pixel" x="24" y="16" width="4" height="4" fill="#FFF"/><rect class="pixel" x="36" y="16" width="4" height="4" fill="#FFF"/><rect class="pixel" x="26" y="18" width="2" height="2" fill="#000"/><rect class="pixel" x="38" y="18" width="2" height="2" fill="#000"/><rect class="pixel" x="20" y="24" width="4" height="4" fill="#2C1810"/><rect class="pixel" x="24" y="24" width="4" height="4" fill="#2C1810"/><rect class="pixel" x="28" y="24" width="8" height="4" fill="#2C1810"/><rect class="pixel" x="36" y="24" width="4" height="4" fill="#2C1810"/><rect class="pixel" x="40" y="24" width="4" height="4" fill="#2C1810"/><rect class="pixel" x="24" y="28" width="16" height="2" fill="#1A0F08"/><rect class="pixel" x="30" y="20" width="4" height="4" fill="#FFCB9A"/><rect class="pixel" x="28" y="30" width="8" height="2" fill="#8B4513"/><rect class="pixel" x="44" y="28" width="8" height="4" fill="#8B4513"/><rect class="pixel" x="52" y="28" width="4" height="4" fill="#A0522D"/><rect class="pixel" x="56" y="28" width="2" height="4" fill="#F40"/><rect class="pixel" x="58" y="30" width="2" height="2" fill="#FD7"/><rect class="pixel" x="24" y="32" width="16" height="4" fill="#FFDBAC"/><rect class="pixel" x="20" y="36" width="8" height="4" fill="#FFF"/><rect class="pixel" x="36" y="36" width="8" height="4" fill="#FFF"/><rect class="pixel" x="28" y="36" width="8" height="4" fill="#000"/><rect class="pixel" x="26" y="38" width="2" height="2" fill="#000"/><rect class="pixel" x="36" y="38" width="2" height="2" fill="#000"/><rect class="pixel" x="16" y="40" width="32" height="20" fill="#C41E3A"/><rect class="pixel" x="18" y="42" width="2" height="16" fill="#8B1428"/><rect class="pixel" x="44" y="42" width="2" height="16" fill="#8B1428"/><rect class="pixel" x="30" y="44" width="4" height="4" fill="#FD7"/><rect class="pixel" x="30" y="52" width="4" height="4" fill="#FD7"/><rect class="pixel" x="12" y="44" width="4" height="12" fill="#FFF"/><rect class="pixel" x="48" y="44" width="4" height="12" fill="#FFF"/><rect class="pixel" x="12" y="56" width="4" height="4" fill="#FFDBAC"/><rect class="pixel" x="48" y="56" width="4" height="4" fill="#FFDBAC"/><rect class="pixel" x="20" y="60" width="24" height="4" fill="#C41E3A"/></svg>`}} />
              <div style={{background:'#0066ff',border:'3px solid #fff',display:'inline-block',padding:'7px 14px',fontSize:'9px',color:'#fff',fontWeight:'bold'}}>
                ASK DEALER GORDON
              </div>
            </div>

            {/* Messages */}
            <div ref={chatRef} className="chat-messages">
              {chatMessages.length===0&&!isLoadingChat&&(
                <div style={{color:'#666',fontStyle:'italic'}}>Gordon's wisdom appears here. Ask about strategy!</div>
              )}
              {chatMessages.map((msg,idx)=>(
                <div key={idx} style={{
                  background:msg.role==='user'?'#003366':'#1a1a1a',
                  border:`2px solid ${msg.role==='user'?'#0066ff':'#00ff00'}`,
                  padding:'9px', marginBottom:'9px', borderRadius:'3px'
                }}>
                  <div style={{color:msg.role==='user'?'#00aaff':'#00ff00',fontSize:'7px',marginBottom:'4px',fontWeight:'bold'}}>
                    {msg.role==='user'?'YOU':'GORDON'}
                  </div>
                  <div style={{color:'#fff',whiteSpace:'pre-wrap',fontSize:'8px'}}>{msg.content}</div>
                </div>
              ))}
              {isLoadingChat&&(
                <div style={{background:'#1a1a1a',border:'2px solid #00ff00',padding:'9px',borderRadius:'3px'}}>
                  <div style={{color:'#00ff00',fontSize:'7px',marginBottom:'4px',fontWeight:'bold'}}>GORDON</div>
                  <div style={{color:'#666',fontStyle:'italic',fontSize:'8px'}}>Dealing wisdom...</div>
                </div>
              )}
            </div>

            {/* Input */}
            <div className="chat-input-row">
              <input
                type="text"
                value={chatInput}
                onChange={e=>setChatInput(e.target.value)}
                onKeyDown={e=>{if(e.key==='Enter') handleChatSubmit();}}
                placeholder="What's the book say?"
                disabled={isLoadingChat}
              />
              <button onClick={handleChatSubmit} disabled={isLoadingChat||!chatInput.trim()} className="nes-btn" style={{background:'#00aa00',color:'#fff',fontSize:'8px',padding:'10px 16px',whiteSpace:'nowrap'}}>
                ASK
              </button>
            </div>

          </div>
        </div>

      </div>

      {/* FOOTER */}
      <div style={{textAlign:'center',marginTop:'24px',fontSize:'7px',color:'#666',borderTop:'2px solid #333',paddingTop:'16px'}}>
        GORDON ON BLACKJACK Â© 2026 â€¢ LEARN FROM GORDON â€¢ BEAT THE HOUSE
      </div>

    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(GordonOnBlackjack));
</script>
</body>
</html>
